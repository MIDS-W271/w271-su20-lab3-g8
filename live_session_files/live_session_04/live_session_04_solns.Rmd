---
title: 'Statistical Methods for Discrete Response, Time Series, and Panel Data: Live
  ession 4'
author: "Professor Jeffrey Yau"
output:
  pdf_document: 
    latex_engine: xelatex
  html_document: default
---

# Main Topics Covered in Lecture 4:

  * Multinomial probability distribution
  * $IJ$ contingency tables and inference using contingency tables
  * The notion of independence
  * Nominal response models
  * Odds ratios in the context of nominal response models
  * Ordinal logistical regression model
  * Estimation and statistical inference of these models

# Required Readings:

**BL2015:** Christopher R. Bilder and Thomas M. Loughin. Analysis of Categorical Data with R. CRC Press. 2015.

  - Ch.3 (Skip Sections 3.4.3, 3.5)

\newpage
In this exercise, we want to model voters’ self identified party affiliation using their demographic characteristics and a handful of self-indentifying variables. The data was obtained from the **American National Election Survey**, which conducted a survey several months prior to the $2016$ American Presidential elections. *Note that the original survey data uses survey weights, which we will not use here.*

The dataset “*voters.csv*” contains a handful of variables from the survey, and these variables have been cleaned and modified for this exercise. This dataset contains the following variables:

**Variable Name**            |          **Explanations**
-----------------------------|----------------------------------------------
party                        | Categorical variable indicating respondents’       party affiliation: Democrat, Independent, Republican
-----------------------------| ----------------------------------------------
Presjob                      | A seven point scale indicating respondents’ evaluation of President Obama. 1 = Very strongly approve; 7 = Very strongly disapprove
-----------------------------| ----------------------------------------------
Srv_spend                    | Seven point scale representing the degree to       which respondents believe that the government should provide or should not provide services:  1 = Government should provide many fewer services; 7 = Government should provide many more services.
-----------------------------| ----------------------------------------------
age                          | Respondents’ age, as of 2016.
-----------------------------| ----------------------------------------------
race_white                   | Dummy variable taking a value of one if the        respondent is white and is zero otherwise.
-----------------------------| ----------------------------------------------
female                       | Dummy variable taking a value of one if the        respondent is female and is zero otherwise.


#EDA 

Setup Codes and Load Data
```{r, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)

# Load Libraries
library(car)
library(Hmisc)
library(plyr)
library(dplyr)
library(skimr)
library(ggplot2)
library(stargazer)

library(gmodels) # For cross tabulation (SAS and SPSS style)
library(MASS)
library(mcprofile)
library(vcd)
library(nnet)

df <- read.csv("live_session_04_data.csv", stringsAsFactors = FALSE, header = TRUE, sep = ",")

# Make data
str(df)
voters <- df %>%
  dplyr::select(party, presjob, srv_spend,
         age, female, race_white)
voters$presjob <- revalue(as.factor(voters$presjob), 
                          c("1"="Approve", "2"="Approve", 
                            "3"="Neutral", "4"="Neutral",
                            "5"="Neutral", "6"="Not Approve",
                            "7"="Not Approve"))
voters$srv_spend <- revalue(as.factor(voters$srv_spend), 
                          c("1"="Low", "2"="Low", "3"="Low",
                            "4"="Medium", "5"="Medium",
                            "997"="Medium", "6"="High", "7"="High"))
voters$female <- revalue(as.factor(voters$female), 
                         c("0"="Male", "1"="Female"))
voters$race_white <- revalue(as.factor(voters$race_white),
                             c("0"="Non-White", "1"="White"))

str(voters)
skim(voters)

write.csv(voters, file = "voters.csv", sep = ",", 
           row.names = FALSE, col.names = TRUE)

voters <- read.csv("voters.csv", stringsAsFactors = FALSE, header = TRUE, sep = ",")

# Convert all the character variables to factor variables
voters <- voters%>%
  dplyr::mutate_if(sapply(voters, is.character), as.factor)
```

**Breakout-room Discussion:**
  - Discuss the structure of the data
  - Discuss missing values and how you would typically handle them at work
  - Discuss the patterns of these variables 
  - Add additional tables and plots to enhance your EDA where needed
  
```{r, warning=FALSE, message=FALSE}
str(voters)
skim(voters)
describe(voters)

#voters[!complete.cases(voters),]
sapply(voters, function(x) sum(is.na(x)))


# Keep only the complete cases in the dataset
voters2 <- voters[complete.cases(voters),]

# Reorder the categories of srv_spend
voters2$srv_spend <- ordered(voters2$srv_spend, levels = c("Low", "Medium", "High"))

# Attach the dataste
attach(voters2)
```

**Pause and Discuss: Missing values**
For now, we would simply exclude them in our analysis. *In practice, you do not just want to throw away observations without any investigation.*

# EDA:

```{r, warning=FALSE, message=FALSE}
# Descriptive statistics
str(voters2)
skim(voters2)
describe(voters2)

#Univariate Analysis
apply(voters2, 2, table)
exam_cat_var = function(var.names) {
  round(prop.table(table(var.names)),2)
}
apply(voters2, 2, exam_cat_var)

# Bivariate Analysis
cross_tab = function(xvar, yvar) {
  CrossTable(xvar, yvar, digits = 2,
           prop.c = FALSE, prop.t = FALSE, chisq = TRUE)
}
# President Approval by Party
cross_tab(voters2$presjob, voters2$party)
# Spending Sentiment by Party
cross_tab(voters2$srv_spend, voters2$party)
# Gender by Party
cross_tab(voters2$female, voters2$party)
# Race by Party
cross_tab(voters2$race_white, voters2$party)

# Age Distribution by Party
ggplot(voters2, aes(factor(party), age)) +  
  geom_boxplot(aes(fill = factor(party))) + 
  ggtitle("Age by Party Affiliation") + 
  theme(plot.title = element_text(lineheight=1, face="bold")) 

# Age Distribution by President Approval
ggplot(voters2, aes(factor(presjob), age)) +  
  geom_boxplot(aes(fill = factor(presjob))) + 
  ggtitle("Age Distribution by President Approval") + 
  theme(plot.title = element_text(lineheight=1, face="bold")) 

# Age Distribution by Spending Sentiment
ggplot(voters2, aes(factor(srv_spend), age)) +  
  geom_boxplot(aes(fill = factor(srv_spend))) + 
  ggtitle("Age Distribution by Spending Sentiment") + 
  theme(plot.title = element_text(lineheight=1, face="bold")) 

# President Approval by Spending Sentiment, Gender, and Race
cross_tab(voters2$srv_spend, voters2$presjob)
cross_tab(voters2$female, voters2$presjob)
cross_tab(voters2$race_white, voters2$presjob)

# Spending Sentiment by Party and Race
cross_tab(voters2$female, voters2$srv_spend)
cross_tab(voters2$race_white, voters2$srv_spend)
```


# Multinomial Logistic Regression Model

  - Estimate a multinomial logistic regression with only `age`, `female`, and `race_white` as explanatory variables. Call the regression `mod.nomial1`
  - Discussion the estimation results. For instance, is a male more or less likely to be a Democrat (relative to being a Republican)? Answer questions like this using your regression results.


```{r}
mod.nominal1 <- multinom(party ~  age + female + race_white, data = voters2)
summary(mod.nominal1)
```

The *levels()* function show that *Democrat* is stored as the first level of the variable *party*. Therefore, *multinom()* function would use it as the base level.

The estimated regressions are

**Equation 1: Independent vs. Democrat**
$$
log \left( \frac{\widehat{\pi}_{Independent}}{\widehat{\pi}_{Democrat}} \right) = -0.8747 - 0.0047age + 0.5348I(Female) + 0.9389I(White)
$$

**Equation 2: Republican vs. Democrat**
$$
log \left( \frac{\widehat{\pi}_{Republican}}{\widehat{\pi}_{Democrat}} \right) = -2.0041 + 0.0067age + 0.1968I(Female) + 1.4632I(White)
$$


# Statistical Inference

  - As starter, test the existence of the age effect in the logit of independent vs democrat equation. (Hint: For simplicity, use Wald test.)
  - Test the existence of effects of an explanatory variable on all response categories.

```{r}
str(mod.nominal1)
coef(mod.nominal1)
sqrt(vcov(mod.nominal1))
coef(mod.nominal1)[1,2]
sqrt(vcov(mod.nominal1)[2,2])
coef(mod.nominal1)[1,2]/sqrt(vcov(mod.nominal1)[2,2])
```

To test the existence of effect of an explanatory variable on all response categories, we set the hypotheses as follow:

$$
H_0: \beta_{jr} = 0, \quad j=2,\dots,J \quad \text{assuming j=1 is the base category}
H_a: \beta_{jr} \ne 0, \quad \text{for some } j
$$

```{r}
library(car)
Anova(mod.nominal1)
```

The numbers in the column *LR Chisq* is $-2log(\Lambda)$. For instance, this transformed test statistic is $14.738$ for the explanatory *female*, and its corresponding p-value ($Pr(>Chisq)$) is less than 0.001.

# Model Interpretation

  - Interpret the estimated coefficients of the model in terms of estimated odds
  
To interpret the coefficients, we first exponentiate the estimated coefficients

```{r}
round(exp(coefficients(mod.nominal1)),2)
```


# Calculation of Estimated Probabilities

  - Estimated probabilities for each of the observations in the sample (it's also called "Fitted Value")
  - Discuss the estimated probabilities

In practice, however, one could obtaine these estimated probability by simply call the *predict()* function with the correct parameter and a dataset from which the estimated probabilities will be calculated.


```{r}
# The columns are re-orderd to match the ordering of the explanatory variables in the model
str(summary(voters2[,2:5][c(2,3,1,4)]))
summary(voters2[,2:5][c(2,3,1,4)])
skim(voters2[,2:5][c(2,3,1,4)])
summary(mod.nominal1)
```

# Estimated probabilities for each of the observations in the sample (it's also called "Fitted Value")

```{r}
pi.hat <- predict(object = mod.nominal1, newdata = voters2, type = "probs")
cbind(head(voters2[,2:6][c(3,4,5)]), round(head(pi.hat),2))
```




